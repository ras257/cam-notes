name: latex-deploy

on:
  workflow_dispatch:
  push:
    paths:
      - "**.tex"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5.0.0

    - name: Install TeX Live
      uses: zauguin/install-texlive@v4
      with:
        package_file: ${{ github.workspace }}/.github/tl_packages

    - name: Determine changed .tex files
      id: changes
      run: |
        # Fetch list of changed TeX files between the pushed commits
        git diff --name-only "${{ github.event.before }}" "${{ github.event.after }}" | grep '\.tex$' > changed_tex.txt || true

        echo "Changed .tex files:"
        cat changed_tex.txt || echo "None"

        # Exclude root-level preamble.tex and lecture-preamble.tex and anything in the templates folder
        grep -v -E '^(preamble\.tex|lecture-preamble\.tex|templates/.*\.tex)$' changed_tex.txt > texfiles.txt || true

        # Find which main.tex files need recompiling
        echo "" > main_files.txt
        while IFS= read -r file; do
          [ -z "$file" ] && continue  # skip empty lines

          if [[ "$file" == *"main.tex" ]]; then
            echo "$file" >> main_files.txt
          elif [[ "$file" == *"/chapters/"* ]]; then
            main_dir=$(dirname "$(dirname "$file")")
            main_file="$main_dir/main.tex"
            if [ -f "$main_file" ]; then
              echo "$main_file" >> main_files.txt
            fi
          fi
        done < texfiles.txt

        # Remove duplicates and blank lines
        grep -v '^[[:space:]]*$' main_files.txt | sort -u > tmp_main_files.txt
        mv tmp_main_files.txt main_files.txt

        echo "Main.tex files to compile:"
        cat main_files.txt || echo "None"

        # Build comma-separated list for GitHub output
        if [ -s main_files.txt ]; then
          files=$(paste -sd "," main_files.txt)
          echo "main_files=$files" >> $GITHUB_OUTPUT
        else
          echo "main_files=" >> $GITHUB_OUTPUT
        fi

    - name: Compile changed Main.tex files
      if: steps.changes.outputs.main_files != ''
      run: |
        mkdir output
        IFS=',' read -ra files <<< "${{ steps.changes.outputs.main_files }}"
        for file in "${files[@]}"; do
          [ -z "$file" ] && continue
          if [ ! -f "$file" ]; then
            echo "File not found: $file"
            continue
          fi

          dir=$(dirname "$file")
          filename=$(basename "$dir")
          echo "::group::Compiling $filename"
          echo "Compiling $file in $dir"
          cd "$dir"
          latexmk -pdf -interaction=nonstopmode main.tex || true
          cp main.pdf "${{ github.workspace }}/output/$filename.pdf"
          cd - > /dev/null
          echo "::endgroup::"
        done

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy folder via rsync
      run: |
        rsync -avz -e "ssh -p ${{ secrets.SSH_PORT }}" ./output/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_DIR }}pdfs/
